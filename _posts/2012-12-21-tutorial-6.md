---
layout: post
title: "Sencha Touch Tutorial: メモ帳アプリを作る #6"
categories: tutorial
css: jp-post
---

<a href="/public/images/i-memo-app-tutorial2.png"><img src="/public/images/i-memo-app-tutorial2.png" alt="" title="i-memo-app-tutorial" width="601" height="261" class="aligncenter size-full wp-image-564" /></a>



では今回は、編集機能と削除機能を実装しましょう。長くなってきましたが、あともう少しでゴールです。



<!--more-->

<h2><strong>編集機能を作る</strong></h2>

一覧の項目をタップすると、選択したレコードのフォームを表示するようにします。コントローラを以下のように変更して下さい。



<pre><code>Ext.define('Memo.controller.Memo', {
    extend: 'Ext.app.Controller',

    config: {
        ...

        control: {
            'button[action=add]': {
                tap: 'onAddButtonTap'
            },
            'memoform textareafield': {
                change: 'onFieldChange'
            },
            'memolist': {                    // 1
                itemtap: 'onItemTap'         // 2
            }
        }
    },

    ...

    onItemTap: function(list, index, target, record) {  // 3
        this.getMain().push({
            xtype: 'memoform',
            record: record,                             // 4
            title: record.get('title')                  // 5
        });
    }

});
</code></pre>

contol オプションに、memolist コンポーネントのイベントリスナーを登録します（1）。itemtap イベントに、onItemTap メソッドをハンドラとして指定します（2）。onItemTap メソッドを追加します（3）。itemtap イベントのパラメータに record が渡ってくるので、それをそのままフォーム画面のレコードとしてセットします（4）。また、フォーム画面のタイトルに、レコードのタイトルをセットします（5）。これで、一覧の項目を選択した際に、選択した項目の編集ができるようになりました。



<h2><strong>削除機能を作る</strong></h2>

最後に、レコードの削除機能を実装します。フォーム画面の下段にツールバーを配置し、「ごみ箱」ボタンを配置します。Form.js ファイルに以下の記述を加えて下さい。



<pre><code>Ext.define('Memo.view.Form', {
    extend: 'Ext.form.Panel',
    xtype: 'memoform',
    config: {
        items: [
            {
                xtype: 'textareafield',
                name: 'memo',
                height: 800
            },
            {
                xtype: 'toolbar',               // 1
                docked: 'bottom',               // 2
                items: [
                    {
                        xtype: 'spacer'         // 3
                    },
                    {
                        xtype: 'button',        // 4
                        ui: 'flat',
                        iconCls: 'trash',       // 5
                        iconMask: true,
                        action: 'remove'        // 6
                    }
                ]
            }
        ]
    }
});
</code></pre>

フォームの items オプションに toolbar コンポーネントを追加します（1）。下部にドッキングさせます（2）。toolbar コンポーネントにボタンを追加します。ボタンを右寄せにするため、spacer コンポーネントを最初に配置します（3）。続いて、ボタンコンポーネントを配置します（4）。アイコンにゴミ箱をしています（5）。そして action プロパティに、「remove」を指定します。この値はコントローラで利用します。（6）



ファイルを保存して、ブラウザでアプリケーションを更新し、フォーム画面に遷移して下さい。下部に、ツールバーとゴミ箱ボタンが表示されます。



<a href="/public/images/t-b-11.png"><img src="/public/images/t-b-11.png" alt="" title="t-b-11" width="320" height="530" class="alignnone size-full wp-image-548" /></a>



コントローラに削除処理を追加します。



<pre><code>Ext.define('Memo.controller.Memo', {
    ...

    config: {
        ...

        control: {
            'button[action=add]': {
                tap: 'onAddButtonTap'
            },
            'memoform textareafield': {
                change: 'onFieldChange'
            },
            'memolist': {
                itemtap: 'onItemTap'
            },
            'button[action=remove]': {         // 1
                tap: 'onRemoveButtonTap'       // 2
            }
        }
    },

    ...

    onRemoveButtonTap: function() {            // 3
        var form = this.getForm(),
            record = form.getRecord(),
            store = Ext.getStore('Memos');     // 4

        store.remove(record);                  // 5
        store.sync();                          // 6
        this.getMain().onBackButtonTap();      // 7
    }

});
</code></pre>

contol オプションで、ゴミ箱ボタンのイベントリスナーを登録します。ごみ箱ボタンかどうかの判定に action プロパティを利用しています（1）。ボタンをタップした際の、ハンドラとして、onRemoveButtonTap メソッドをマッピングします。（2）



onRmoveButtonTap メソッドを追加します（3）。memoform コンポーネントを取得し、セットしているレコードを取得します。また、Memos ストアを取得します（4）。ストアからレコードを削除します（5）。ストアを更新（6）。最後に一覧に戻る処理を実行します。（7）



以上で、アプリケーションの機能は完成です。データを一覧表示し、追加、編集、削除ができるようになりました。<a href="http://shinobukawano.com/2012/12/tutorial-7/">次回</a>は最終回ということで、デザインのカスタマイズから、デプロイ、ネイティブパッケージングまでを取り上げます。



