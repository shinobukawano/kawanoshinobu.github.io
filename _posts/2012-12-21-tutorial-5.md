---
layout: post
title: "Sencha Touch Tutorial: メモ帳アプリを作る #5"
categories: tutorial
css: jp-post
---

<a href="/public/images/i-memo-app-tutorial2.png"><img src="/public/images/i-memo-app-tutorial2.png" alt="" title="i-memo-app-tutorial" width="601" height="261" class="aligncenter size-full wp-image-564" /></a>



今回と次回が、チュートリアルの山場です。機能の核となるデータの作成・更新・削除機能を実装します。今回は、モデル、ストアを作成し、データの新規作成までを扱います。



<!--more-->

<h2><strong>データの保存処理を作る</strong></h2>

<h3><strong>モデル</strong></h3>

データを保存するために、モデルクラスを作成します。コントローラクラスと同様、モデルクラスも Sencha Cmd で生成できます。アプリケーションのディレクトリで、以下のコマンドを実行して下さい。



<pre><code>$ sencha generate model -n Memo -f id,title,memo
</code></pre>

-f オプションで、モデルのフィールドを定義しています。Memo モデルは、「id」「title」「memo」の3つのフィールドを持つことにします。



このコマンドにより、model ディレクトリ以下に、Memo.js というファイルが生成されました。また、コントローラの生成時と同様、app.js の models オプションに利用宣言が追加されています。（1）



<pre><code>Ext.application({
    models: ["Memo"],          // 1

    controllers: ["Memo"],

    name: 'Memo',

    requires: [
        ...
</code></pre>

<h3><strong>ストア</strong></h3>

続いて、ストアクラスを作成します。ストアは Sencha Cmd の生成コマンドがないので、手動でファイルを作成します。store ディレクトリの下に、Memos.js というファイルを作成して下さい。ファイルに以下の記述を行います。



<pre><code>Ext.define('Memo.store.Memos', {
    extend: 'Ext.data.Store',
    requires: [
        'Ext.data.proxy.LocalStorage'
    ],
    config: {
        model: 'Memo.model.Memo',      // 1
        proxy: {                       // 2
            type: 'localstorage',      // 3
            id: 'memo'                 // 4
        },
        autoLoad: true                 // 5
    }
});
</code></pre>

作成したストアクラスをアプリケーションで利用できるよう、app.js の stores オプションに宣言を追加します。（1）



<pre><code>Ext.application({
    models: ["Memo"],

    stores: ['Memos'],                 // 1

    controllers: ["Memo"],

    name: 'Memo',

    ...
</code></pre>

models オプションで、「Memo.model.Memo」モデルの利用を指定します（1）。続いて、プロキシを設定します。プロキシは読み込み先と保存先を指定するインターフェイスです（2）。メモ帳アプリは、ブラウザの localStorage にデータを保存するので、type に「localstorage」を指定します（3）。localstorage プロキシは、アプリケーション内で一意となる id が必要です。ここでは、「memo」という id を指定します（4）。最後に、利用時にデータを自動で読み込むよう、autoLoad オプションに true を指定します。（5）



<h3><strong>モデル・ストアを利用する</strong></h3>

前々回作成した memolist コンポーネントの記述を変更します。data オプションで簡易的に3件のデータを指定していましたが、それを「Memo.store.Memos」ストアを利用するように書き換えます。（1）



<pre><code>Ext.define('Memo.view.List', {
    extend: 'Ext.dataview.List',
    xtype: 'memolist',
    config: {
        store: 'Memos',                // 1
        itemTpl: '{title}'
    }
});
</code></pre>

データの保存処理を実装しましょう。textareafield コンポーネントの編集が終わったタイミングで保存を行うようにします。コントローラで以下の記述を加えて下さい。



<pre><code>Ext.define('Memo.controller.Memo', {
    extend: 'Ext.app.Controller',

    config: {
        refs: {
            main: 'main',
            form: 'memoform'              // 1
        },
        control: {
            'button[action=add]': {
                tap: 'onAddButtonTap'
            },
            'memoform textareafield': {    // 2
                change: 'onFieldChange'    // 3
            }
        }
    },

    onAddButtonTap: function() {
        var record = Ext.create('Memo.model.Memo', {    // 4
            id: String(Ext.Date.now())                  // 5
        });

        this.getMain().push({
            xtype: 'memoform',
            record: record                              // 6
        });
    },

    onFieldChange: function(field, value) {                            // 7
        var form = this.getForm(),
            record = form.getRecord();                                 // 8

        record.set('title', Ext.String.ellipsis(value, 10));           // 9
        record.set('memo', value);                                     // 10

        var store = Ext.getStore('Memos');                             // 11
        if (Ext.isEmpty(store.findRecord('id', record.get('id')))) {
            store.add(record);                                         // 12
        }
        store.sync();                                                  // 13
    }

});
</code></pre>

まず、memoform コンポーネントの参照を refs オプションに定義します（1）。続いて、memoform コンポーネント以下にある textareafield コンポーネントのイベントリスナーを control オプションに定義します（2）。ここでは、textareafield コンポーネントが発火する change イベントに対して、onFieldChange メソッドをハンドラに登録しています。（3）



onAddButtonTap ハンドラに、新規レコードの作成処理を追加します（4）。id は一意になる値をセットしたいので、ここでは Ext.Date.now メソッドを使ってタイムスタンプを指定します（5）。



<strong>2/11追記：</strong>id に格納する値の型を、文字列に変換します。現仕様では、値が文字列型でない場合、データが正しく消去されない問題があります => <a href="http://stackoverflow.com/questions/10863204/sencha-touch-localstore-proxy-not-removing-indexes-after-records-deleted">http://stackoverflow.com/questions/10863204/sencha-touch-localstore-proxy-not-removing-indexes-after-records-deleted</a> <a href="https://twitter.com/Mt_blue81">@Mt_blue81</a> さん、<a href="https://twitter.com/dsuket">@dsuket</a> さん、どうもありがとうございました！



画面遷移の際、フォームにレコードを設定します（6）。



textareafield コンポーネントの値が変更されたタイミングで、localStorage にレコードを保存します。ハンドラとして、onFieldChange メソッドを追加します（7）。フォームからレコードを取得します（8）。取得したレコードの値を更新します。title フィールドには、変更された値を前から10文字取得し、省略記号 ... を付加した値をセットします。省略処理に Ext.String.ellipsis メソッドを利用しています（9）。memo フィールドには、フォームの値を全て登録します（10）。



最後に、レコードの保存を行います。Memos ストアを取得し（11）、指定した id のストアが存在しない場合は新しく追加します（12）。最後に sync メソッドを実行して、ストアの値を更新します。（13）



ブラウザをリロードし、アプリを更新。作成画面に遷移し、フォームの値を入力して下さい。その後、リストに戻り、作成したレコードが一覧に追加されていれば、実装は成功です。



<a href="/public/images/b-t-10.png"><img src="/public/images/b-t-10.png" alt="" title="b-t-10" width="320" height="530" class="alignnone size-full wp-image-539" /></a>



<a href="http://kawanoshinobu.com/2012/12/tutorial-6/">次回</a>に続きます。


